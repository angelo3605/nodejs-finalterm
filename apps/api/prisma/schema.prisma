generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Role {
  CUSTOMER
  ADMIN
  BLOCKED
}

enum OrderStatus {
  PENDING
  PROCESSING
  DELIVERING
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

enum CartStatus {
  ACTIVE
  CHECKED_OUT
}

type ShippingInfo {
  street      String
  phoneNumber String
  fullName    String
}

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  fullName      String?
  email         String?    @unique
  password      String?
  role          Role      @default(CUSTOMER)
  loyaltyPoints Int       @default(0)

  oauths            OAuthAccount[]
  resetTokens       PasswordResetToken[]
  shippingAddresses ShippingAddress[]
  carts             Cart[]
  orders            Order[]
  comments          Comment[]
  ratings           Rating[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model OAuthAccount {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  provider   String
  providerId String
  userId     String   @db.ObjectId
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([provider, providerId])
}

model PasswordResetToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  token     String
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model ShippingAddress {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  fullName    String
  address     String
  phoneNumber String
  isDefault   Boolean  @default(false)

  userId      String   @db.ObjectId
  user        User     @relation(fields: [userId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Brand {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  slug      String    @unique
  name      String
  isDeleted Boolean   @default(false)

  products  Product[]

  @@index([isDeleted])
}

model Category {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  slug      String    @unique
  name      String
  desc      String?
  imageUrl  String?
  isDeleted Boolean   @default(false)

  products  Product[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([isDeleted])
}

model Product {
  id          String           @id @default(auto()) @map("_id") @db.ObjectId
  slug        String           @unique
  name        String
  desc        String?
  isDeleted   Boolean          @default(false)

  brandId     String?          @db.ObjectId
  brand       Brand?           @relation(fields: [brandId], references: [id])
  categoryId  String?          @db.ObjectId
  category    Category?        @relation(fields: [categoryId], references: [id])
  
  variants    ProductVariant[]
  imageUrls   String[]
  comments    Comment[]
  ratings     Rating[]
  images      Image[]          @relation("ProductImages")
  
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([isDeleted])
}

model ProductVariant {
  id            String          @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  price         Float
  stockQuantity Int
  isDeleted     Boolean         @default(false)

  productId     String          @db.ObjectId
  product       Product         @relation(fields: [productId], references: [id])
  
  orderItems    OrderItem[]
  cartItems     CartItem[]
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([isDeleted])
}

model Image {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  url       String
  filePath  String
  altText   String?

  productId String   @db.ObjectId
  product   Product  @relation("ProductImages", fields: [productId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Comment {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  message   String

  parentId  String?    @db.ObjectId
  parent    Comment?   @relation("CommentReplies", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies   Comment[]  @relation("CommentReplies")

  userId    String     @db.ObjectId
  user      User       @relation(fields: [userId], references: [id])
  productId String     @db.ObjectId
  product   Product    @relation(fields: [productId], references: [id])

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([productId])
  @@index([userId])
}

model Rating {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  stars     Int

  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  productId String   @db.ObjectId
  product   Product  @relation(fields: [productId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([userId])
}

model Cart {
  id        String      @id @default(auto()) @map("_id") @db.ObjectId
  sumAmount Float
  status    CartStatus  @default(ACTIVE)

  userId    String      @db.ObjectId
  user      User        @relation(fields: [userId], references: [id])

  cartItems CartItem[]

  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@index([userId])
}

model CartItem {
  id         String          @id @default(auto()) @map("_id") @db.ObjectId
  quantity   Int             @default(1)

  cartId     String          @db.ObjectId
  cart       Cart            @relation(fields: [cartId], references: [id])
  variantId  String          @db.ObjectId
  variant    ProductVariant  @relation(fields: [variantId], references: [id])
  
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
}

model Order {
  id             String        @id @default(auto()) @map("_id") @db.ObjectId
  sumAmount      Float
  totalAmount    Float
  status         OrderStatus   @default(PENDING)

  userId         String        @db.ObjectId
  user           User          @relation(fields: [userId], references: [id])
  orderItems     OrderItem[]
  payments       Payment[]
  discountCodeId String?       @db.ObjectId
  discountCode   DiscountCode? @relation(fields: [discountCodeId], references: [id])

  shippingAddress ShippingInfo

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  @@index([userId])
}

model OrderItem {
  id          String          @id @default(auto()) @map("_id") @db.ObjectId
  quantity    Int
  unitPrice   Float
  sumAmount   Float
  
  orderId     String          @db.ObjectId
  order       Order           @relation(fields: [orderId], references: [id])
  variantId   String          @db.ObjectId
  variant     ProductVariant  @relation(fields: [variantId], references: [id])

  productName String
  variantName String

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([orderId])
  @@index([variantId])
}

model Payment {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  transactionId String
  method        String
  currency      String
  amount        Float
  status        PaymentStatus @default(PENDING)
  
  orderId       String        @db.ObjectId
  order         Order         @relation(fields: [orderId], references: [id])
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([orderId])
}

model DiscountCode {
  id          String        @id @default(auto()) @map("_id") @db.ObjectId
  code        String        @unique
  desc        String?
  type        DiscountType
  value       Float
  usageLimit  Int?
  numOfUsage  Int           @default(0)
  
  orders      Order[]
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model RevokedToken {
  id          String        @id @default(auto()) @map("_id") @db.ObjectId
  jti String @unique
  revokedAt DateTime @default(now())
}